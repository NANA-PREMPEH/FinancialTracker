{% extends "base.html" %}

{% block title %}Dashboard - Financial Tracker{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 style="margin: 0;">Dashboard</h1>
    <button onclick="togglePrivacy()" id="privacyToggle" class="btn-privacy">
        <span id="privacyIcon">üëÅÔ∏è</span> <span id="privacyText">Hide Amounts</span>
    </button>
</div>

<div class="dashboard-summary-wrapper">
    <div class="glass-grid">
        <div class="glass-panel">
            <h2>Total Expenses</h2>
            <p class="text-muted">as at {{ current_date.strftime('%d %B %Y') }}</p>
            <div class="amount-value" data-amount="GHS {{ '{:,.2f}'.format(total_expenses) }}">GHS {{ "{:,.2f}".format(total_expenses) }}</div>
        </div>

        <div class="glass-panel">
            <h2>Current Year Expenses</h2>
            <p class="text-muted">Year {{ current_date.strftime('%Y') }}</p>
            <div class="amount-value" data-amount="GHS {{ '{:,.2f}'.format(yearly_expenses) }}">GHS {{ "{:,.2f}".format(yearly_expenses) }}</div>
        </div>

        <div class="glass-panel">
            <h2>Current Month Expenses</h2>
            <p class="text-muted">{{ current_date.strftime('%B %Y') }}</p>
            <div class="amount-value" data-amount="GHS {{ '{:,.2f}'.format(monthly_expenses) }}">GHS {{ "{:,.2f}".format(monthly_expenses) }}</div>
        </div>

        <div class="glass-panel">
            <h2>Total Wallet Balance</h2>
            <p class="text-muted">All Wallets Combined</p>
            <div class="amount-value" data-amount="GHS {{ '{:,.2f}'.format(total_wallet_balance) }}">GHS {{ "{:,.2f}".format(total_wallet_balance) }}</div>
            <button onclick="convertCurrency()" class="btn-convert">
                üí± Convert to Currencies
            </button>
        </div>
    </div>
</div>

<!-- Currency Conversion Modal -->
<div id="conversionModal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin: 0;">Currency Conversions</h2>
            <button onclick="closeConversionModal()" class="modal-close">&times;</button>
        </div>
        <div id="conversionResults">
            <p class="text-muted" style="text-align: center;">Loading exchange rates...</p>
        </div>
    </div>
</div>

<h2>Recent Expenses</h2>
{% if recent_expenses %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Category</th>
                <th class="text-right">Amount (GHS)</th>
                <th style="width: 120px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in recent_expenses %}
            <tr>
                <td>{{ expense.date.strftime('%d %b %Y') }}</td>
                <td>
                    <div>{{ expense.description }}</div>
                    {% if expense.tags %}
                        <div style="margin-top: 0.25rem;">
                            {% for tag in expense.tags.split(',') %}
                                <span class="tag-badge">{{ tag.strip() }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </td>
                <td>
                    <span style="font-size: 1.25rem; margin-right: 0.5rem;">{{ expense.category.icon }}</span>
                    {{ expense.category.name }}
                </td>
                <td class="currency">
                    {% if expense.receipt_path %}
                        <span class="receipt-indicator" title="Has receipt">üìé</span>
                    {% endif %}
                    {{ "%.2f"|format(expense.amount) }}
                </td>
                <td>
                    <a href="{{ url_for('main.edit_expense', id=expense.id) }}" class="btn-sm btn-secondary" style="text-decoration: none; display: inline-block;">Edit</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 1rem;">
        <a href="{{ url_for('main.all_expenses') }}" style="font-weight: bold;">View all expenses &rarr;</a>
    </div>
{% else %}
    <p>No expenses recorded yet.</p>
    <a href="{{ url_for('main.add_expense') }}" class="button">Add your first expense</a>
{% endif %}

<script>
// Privacy Toggle Feature
let isPrivacyMode = localStorage.getItem('privacyMode') === 'true';

function togglePrivacy() {
    isPrivacyMode = !isPrivacyMode;
    localStorage.setItem('privacyMode', isPrivacyMode);
    
    const amounts = document.querySelectorAll('.amount-value');
    const icon = document.getElementById('privacyIcon');
    const text = document.getElementById('privacyText');
    
    amounts.forEach(amount => {
        if (isPrivacyMode) {
            amount.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        } else {
            amount.textContent = amount.getAttribute('data-amount');
        }
    });
    
    if (isPrivacyMode) {
        icon.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        text.textContent = 'Show Amounts';
    } else {
        icon.textContent = 'üëÅÔ∏è';
        text.textContent = 'Hide Amounts';
    }
}

// Initialize privacy state on page load
document.addEventListener('DOMContentLoaded', function() {
    if (isPrivacyMode) {
        togglePrivacy();
    }
});

    function convertCurrency() {
        const modal = document.getElementById('conversionModal');
        modal.style.display = 'flex';
        
        const amount = {{ total_wallet_balance }};
        
        // Fetch conversion data from API
        fetch('{{ url_for("main.convert_currency") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ amount: amount })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayConversions(data.conversions);
            } else {
                document.getElementById('conversionResults').innerHTML = 
                    '<p class="text-danger">Error: ' + data.error + '</p>';
            }
        })
        .catch(error => {
            document.getElementById('conversionResults').innerHTML = 
                '<p class="text-danger">Error fetching exchange rates. Please try again.</p>';
            console.error('Error:', error);
        });
    }

    function displayConversions(conversions) {
        const currencyNames = {
            'GHS': 'Ghanaian Cedi',
            'USD': 'US Dollar',
            'EUR': 'Euro',
            'GBP': 'British Pound',
            'JPY': 'Japanese Yen',
            'CNY': 'Chinese Yuan'
        };
        
        const currencyFlags = {
            'GHS': 'üá¨üá≠',
            'USD': 'üá∫üá∏',
            'EUR': 'üá™üá∫',
            'GBP': 'üá¨üáß',
            'JPY': 'üáØüáµ',
            'CNY': 'üá®üá≥'
        };
        
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: var(--color-surface-hover);">';
        html += '<th style="padding: 1rem; text-align: left; color: var(--color-text-muted);">Currency</th>';
        html += '<th style="padding: 1rem; text-align: right; color: var(--color-text-muted);">Amount</th>';
        html += '</tr></thead><tbody>';
        
        for (const [currency, amount] of Object.entries(conversions)) {
            const flag = currencyFlags[currency] || '';
            const name = currencyNames[currency] || currency;
            const formattedAmount = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
            
            html += '<tr style="border-bottom: 1px solid var(--color-border);">';
            html += `<td style="padding: 1rem; color: var(--color-text);"><span style="font-size: 1.5rem; margin-right: 0.5rem;">${flag}</span>${name} (${currency})</td>`;
            html += `<td style="padding: 1rem; text-align: right; font-weight: bold; color: var(--color-text);">${formattedAmount}</td>`;
            html += '</tr>';
        }
        
        html += '</tbody></table>';
        html += '<p class="text-muted" style="margin-top: 1.5rem; font-size: 0.9rem; text-align: center;">Exchange rates provided by ExchangeRate-API</p>';
        
        document.getElementById('conversionResults').innerHTML = html;
    }

    function closeConversionModal() {
        document.getElementById('conversionModal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.getElementById('conversionModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeConversionModal();
        }
    });
</script>

{% endblock %}
