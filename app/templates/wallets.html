{% extends "base.html" %}

{% block title %}Wallets - Financial Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="flex justify-between items-center mb-8">
        <div class="flex gap-2">
            <button onclick="showTransferModal()" class="btn-secondary">
                 ‚ÜîÔ∏è Transfer Funds
            </button>
            <a href="{{ url_for('main.add_wallet') }}">
                <button>+ Add Wallet</button>
            </a>
        </div>
    </div>

    <div class="grid-wallets">
        {% for wallet in wallets %}
        <div class="card wallet-card">
            <div class="wallet-icon">{{ wallet.icon }}</div>
            <h3 class="wallet-name">{{ wallet.name }}</h3>
            <p class="wallet-type">{{ wallet.wallet_type|title }}{% if wallet.is_shared %} ‚Ä¢ Shared{% endif %}</p>
            {% if wallet.account_number %}
            <p class="wallet-account">Acct: {{ wallet.account_number }}</p>
            {% else %}
            <div class="wallet-spacer"></div>
            {% endif %}
            <div class="wallet-balance">{{ wallet.currency }} {{ "%.2f"|format(wallet.balance) }}</div>
            <p class="wallet-label">Current Balance</p>
            
            <div class="wallet-actions">
                <a href="{{ url_for('main.edit_wallet', id=wallet.id) }}" class="btn-edit action-link" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
                    ‚úèÔ∏è Edit
                </a>
                <button class="delete-wallet-btn btn-delete" data-id="{{ wallet.id }}" data-name="{{ wallet.name }}">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not wallets %}
        <p>No wallets yet. Create your first wallet to start tracking!</p>
    {% endif %}

    <!-- Transfer History Section -->
    {% if transfers %}
    <div style="margin-top: 3rem;">
        <div class="flex justify-between items-center mb-4">
            <h2>Transfer History</h2>
            <a href="{{ url_for('main.all_expenses', category=transfers[0].category_id) }}" class="action-link">See All</a>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>From/To</th>
                        <th>Amount</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transfer in transfers %}
                    <tr>
                        <td>{{ transfer.date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ transfer.description }}</td>
                        <td>{{ transfer.wallet.name }}</td>
                        <td class="{{ 'text-danger' if transfer.transaction_type == 'expense' else 'text-success' }}">
                            {{ transfer.wallet.currency }} {{ "%.2f"|format(transfer.amount) }}
                        </td>
                        <td>
                            <span class="badge {{ 'badge-danger' if transfer.transaction_type == 'expense' else 'badge-success' }}">
                                {{ 'Outgoing' if transfer.transaction_type == 'expense' else 'Incoming' }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Transfer Funds Modal -->
<div id="transferModal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 500px;">
        <h3 style="margin-top: 0; margin-bottom: 1.5rem;">‚ÜîÔ∏è Transfer Funds</h3>
        
        <form action="{{ url_for('main.transfer_funds') }}" method="POST">
            <div class="form-group mb-4">
                <label class="form-label">Source Wallet (From)</label>
                <select name="source_wallet_id" id="source_wallet" class="form-control" required onchange="updateDestOptions()">
                    <option value="" disabled selected>Select Source Wallet</option>
                    {% for wallet in wallets %}
                    <option value="{{ wallet.id }}" data-currency="{{ wallet.currency }}">{{ wallet.name }} ({{ wallet.currency }} {{ "%.2f"|format(wallet.balance) }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group mb-4">
                <label class="form-label">Destination Wallet (To)</label>
                <select name="dest_wallet_id" id="dest_wallet" class="form-control" required>
                    <option value="" disabled selected>Select Destination Wallet</option>
                    {% for wallet in wallets %}
                    <option value="{{ wallet.id }}" data-currency="{{ wallet.currency }}">{{ wallet.name }} ({{ wallet.currency }} {{ "%.2f"|format(wallet.balance) }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group mb-4">
                <label class="form-label">Amount</label>
                <input type="number" name="amount" step="0.01" min="0.01" class="form-control" required placeholder="0.00">
            </div>

            <div class="form-group mb-6">
                <label class="form-label">Date</label>
                <input type="date" name="date" class="form-control" value="{{ now_date }}">
            </div>

            <div class="flex gap-4 justify-end">
                <button type="button" onclick="hideTransferModal()" class="btn-secondary">
                    Cancel
                </button>
                <button type="submit" class="btn-primary">
                    Transfer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteWalletModal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 400px;">
        <h3 class="text-danger" style="margin-top: 0; margin-bottom: 1rem;">‚ö†Ô∏è Delete Wallet</h3>
        <p id="deleteWalletMessage" class="text-muted" style="margin-bottom: 1.5rem;"></p>
        <div class="flex gap-4 justify-end">
            <button onclick="hideDeleteWalletDialog()" class="btn-secondary">
                Cancel
            </button>
            <button onclick="confirmDeleteWallet()" class="btn-danger">
                Delete
            </button>
        </div>
    </div>
</div>

<form id="deleteWalletForm" method="POST" style="display: none;">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default date to today
    const dateInputs = document.querySelectorAll('input[type="date"]');
    const today = new Date().toISOString().split('T')[0];
    dateInputs.forEach(input => {
        if (!input.value) input.value = today;
    });

    let walletToDelete = null;
    const deleteModal = document.getElementById('deleteWalletModal');
    const deleteMessage = document.getElementById('deleteWalletMessage');
    const deleteForm = document.getElementById('deleteWalletForm');
    
    // Transfer Modal Logic
    const transferModal = document.getElementById('transferModal');
    const sourceSelect = document.getElementById('source_wallet');
    const destSelect = document.getElementById('dest_wallet');

    window.showTransferModal = function() {
        transferModal.style.display = 'flex';
    };

    window.hideTransferModal = function() {
        transferModal.style.display = 'none';
        // Reset form? maybe later
    };

    window.updateDestOptions = function() {
        const sourceId = sourceSelect.value;
        const destOptions = destSelect.options;
        
        for (let i = 0; i < destOptions.length; i++) {
            if (destOptions[i].value === sourceId) {
                destOptions[i].disabled = true;
                if (destSelect.value === sourceId) {
                    destSelect.value = "";
                }
            } else {
                destOptions[i].disabled = false;
            }
        }
    };

    // Attach click handlers to all delete buttons
    document.querySelectorAll('.delete-wallet-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            walletToDelete = id;
            deleteMessage.textContent = `Are you sure you want to delete the wallet "${name}"? This action cannot be undone.`;
            deleteModal.style.display = 'flex';
        });
    });

    window.hideDeleteWalletDialog = function() {
        deleteModal.style.display = 'none';
        walletToDelete = null;
    };

    window.confirmDeleteWallet = function() {
        if (walletToDelete) {
            deleteForm.action = `/wallets/delete/${walletToDelete}`;
            deleteForm.submit();
        }
    };

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == deleteModal) {
            hideDeleteWalletDialog();
        }
        if (event.target == transferModal) {
            hideTransferModal();
        }
    };
});
</script>
{% endblock %}
