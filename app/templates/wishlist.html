{% extends "base.html" %}

{% block title %}Wishlist - Financial Tracker{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>‚ú® Wishlist (To-Do)</h1>
        <button onclick="document.getElementById('addModal').style.display='block'" 
            style="background: var(--color-primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
            + Add Item
        </button>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 2rem; border-radius: 12px; position: relative;">
            <span onclick="document.getElementById('addModal').style.display='none'" 
                style="position: absolute; right: 20px; top: 20px; cursor: pointer; font-size: 1.5rem;">&times;</span>
            
            <h2 id="modalTitle" style="margin-top: 0;">Add Wishlist Item</h2>
            <form id="wishlistForm" action="{{ url_for('main.add_wishlist_item') }}" method="POST" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label>Item Name</label>
                    <input type="text" id="nameInput" name="name" required 
                        style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label>Est. Amount</label>
                        <input type="number" id="amountInput" name="amount" step="0.01" value="0.00" required
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label>Priority</label>
                        <select id="priorityInput" name="priority" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label>Category (Optional)</label>
                    <select id="categoryInput" name="category_id" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- Select Category --</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label>Notes</label>
                    <textarea id="notesInput" name="notes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>

                <button type="submit" style="background: var(--color-primary); color: white; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    Save Item
                </button>
            </form>
        </div>
    </div>

    {% if items %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            {% for item in items %}
            <div class="card" id="wishlist-{{ item.id }}" style="margin-bottom: 0; border-left: 5px solid {{ 'var(--color-expense)' if item.priority == 'High' else ('#ffc107' if item.priority == 'Medium' else '#4caf50') }};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h3 style="margin: 0 0 0.5rem 0;">{{ item.name }}</h3>
                        <p style="margin: 0; color: var(--color-text-muted); font-size: 0.9rem;">
                            {{ item.category.icon if item.category else 'üì¶' }} {{ item.category.name if item.category else 'Uncategorized' }}
                        </p>
                    </div>
                    <div style="text-align: right;">
                        <strong style="font-size: 1.1rem; display: block;">{{ "{:,.2f}".format(item.amount) }}</strong>
                        <span style="font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555;">
                            {{ item.priority }} Priority
                        </span>
                    </div>
                </div>

                {% if item.notes %}
                    <p style="color: #666; font-size: 0.9rem; margin: 1rem 0; font-style: italic;">{{ item.notes }}</p>
                {% else %}
                    <div style="margin-bottom: 1rem;"></div>
                {% endif %}

                <div style="display: flex; gap: 0.5rem; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                    <!-- Execute Button -->
                    <form action="{{ url_for('main.execute_wishlist_item', id=item.id) }}" method="POST" style="flex: 1;">
                        <button type="submit" onclick="return confirm('Execute this item? It will be moved to your daily expenses.')"
                            style="width: 100%; background: #4caf50; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">
                            ‚úÖ Execute
                        </button>
                    </form>

                    <!-- Edit Button -->
                    <button onclick="editItem(this)"
                        data-id="{{ item.id }}"
                        data-name="{{ item.name }}"
                        data-amount="{{ item.amount }}"
                        data-category="{{ item.category_id or '' }}"
                        data-priority="{{ item.priority }}"
                        data-notes="{{ item.notes or '' }}"
                        style="background: #eee; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer;">
                        ‚úèÔ∏è
                    </button>

                    <!-- Delete Button -->
                    <form action="{{ url_for('main.delete_wishlist_item', id=item.id) }}" method="POST">
                        <button type="submit" onclick="return confirm('Delete this item permanently?')"
                            style="background: #fee; color: #f44336; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--color-text-muted);">
            <p style="font-size: 1.2rem;">Your wishlist is empty.</p>
            <p>Add items you plan to buy in the future!</p>
            <button onclick="document.getElementById('addModal').style.display='block'" 
                style="margin-top: 1rem; background: var(--color-primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                Start a Wishlist
            </button>
        </div>
    {% endif %}

</div>

<script>
    function editItem(btn) {
        document.getElementById('modalTitle').innerText = 'Edit Wishlist Item';
        
        const id = btn.getAttribute('data-id');
        const baseUrl = "{{ url_for('main.edit_wishlist_item', id=0) }}";
        const actionUrl = baseUrl.replace('/0', '/' + id);
        
        document.getElementById('wishlistForm').action = actionUrl;
        
        document.getElementById('nameInput').value = btn.getAttribute('data-name');
        document.getElementById('amountInput').value = btn.getAttribute('data-amount');
        document.getElementById('priorityInput').value = btn.getAttribute('data-priority');
        document.getElementById('categoryInput').value = btn.getAttribute('data-category');
        document.getElementById('notesInput').value = btn.getAttribute('data-notes');
        
        document.getElementById('addModal').style.display = 'block';
    }

    // Reset form when opening via main Add button
    // (Assuming the main button reloads page or we attach a handler. 
    // The main button has inline onclick, so we can't easily hook in unless we change it or use event delegation)
    // Actually, inline onclick just opens modal. Form details remain from last edit if not cleared.
    // I should fix the main add button to call a function.
    
    // Let's add an event listener to the main button to clear form
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.querySelector('button[onclick*="addModal"]');
        if(addBtn) {
            addBtn.onclick = function() {
                openAddModal();
            };
        }
    });

    function openAddModal() {
        document.getElementById('modalTitle').innerText = 'Add Wishlist Item';
        document.getElementById('wishlistForm').action = "{{ url_for('main.add_wishlist_item') }}";
        document.getElementById('wishlistForm').reset();
        document.getElementById('addModal').style.display = 'block';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == document.getElementById('addModal')) {
            document.getElementById('addModal').style.display = "none";
        }
    }
</script>
{% endblock %}
