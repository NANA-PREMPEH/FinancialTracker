{% extends "base.html" %}

{% block title %}{{ project.name }} - Financial Tracker{% endblock %}

{% block content %}
<div class="card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1>{{ project.name }}</h1>
            {% if project.description %}
            <p
                style="color: var(--color-text); margin-top: 0.5rem; margin-bottom: 0.75rem;">
                {{ project.description }}
            </p>
            {% endif %}
            <p style="color: var(--color-text-muted); margin-top: 0.5rem;">
                üí∞ Funding:
                {% if project.funding_source == 'wallet' and project.wallet %}
                {{ project.wallet.name }}
                {% elif project.funding_source == 'other' %}
                {{ project.custom_funding_source }}
                {% else %}
                {{ project.funding_source|replace('_', ' ')|title }}
                {% endif %}
            </p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('main.edit_project', id=project.id) }}">
                <button style="background-color: var(--color-primary);">‚úèÔ∏è Edit
                    Project</button>
            </a>
            <button type="button" onclick="showDeleteProjectDialog()"
                style="background-color: var(--color-danger);">üóëÔ∏è
                Delete</button>
        </div>
    </div>

    <!-- Add Item Form -->
    <div class="card" style="background-color: #f8f9fa; margin-bottom: 2rem;">
        <h3 style="margin-top: 0;">Add New Item</h3>
        <form method="POST"
            action="{{ url_for('main.add_project_item', project_id=project.id) }}"
            style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                    <label for="item_name">Item Name</label>
                    <input type="text" id="item_name" name="item_name"
                        placeholder="e.g., Venue Booking, Catering" required>
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label for="cost">Cost (GHS)</label>
                    <input type="number" id="cost" name="cost" step="0.01"
                        min="0" value="0.00" required>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="description">Description (Optional)</label>
                <textarea id="description" name="description" rows="2"
                    placeholder="Add details about this item..."></textarea>
            </div>
            <button type="submit" style="align-self: flex-start;">+ Add
                Item</button>
        </form>
    </div>

    <!-- Items List -->
    <div>
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <h2>Project List</h2>
                <input type="text" id="searchProjectItems" onkeyup="filterProjectItems()" 
                    placeholder="Search items..." 
                    style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; width: 200px;">
            </div>
            <div style="text-align: right;">
                <p
                    style="font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 0.25rem;">Total
                    Items: {{ project.items|length }}</p>
                <div style="display: flex; gap: 2rem; align-items: center;">
                    <div>
                        <p style="font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 0.25rem;">‚úì Completed</p>
                        <p
                            style="font-size: 1.25rem; font-weight: 700; color: #4caf50; margin: 0;">GHS
                            {{ "{:,.2f}".format(completed_cost) }}</p>
                    </div>
                    <div>
                        <p style="font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 0.25rem;">‚è≥ Not Completed</p>
                        <p
                            style="font-size: 1.25rem; font-weight: 700; color: #ff9800; margin: 0;">GHS
                            {{ "{:,.2f}".format(not_completed_cost) }}</p>
                    </div>
                    <div>
                        <p style="font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 0.25rem;">Total Cost</p>
                        <p
                            style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary); margin: 0;">GHS
                            {{ "{:,.2f}".format(project.total_cost) }}</p>
                    </div>
                </div>
            </div>
        </div>

        {% if project.items %}
        <div style="display: grid; gap: 1rem;">
            {% for item in project.items %}
            <div class="card project-item-card"
                style="background-color: white; border-left: 4px solid var(--color-primary);">
                <div
                    style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0;">
                            {{ item.item_name }}
                        </h4>
                        {% if item.description %}
                        <p
                            style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--color-text); white-space: pre-wrap;">
                            {{ item.description }}
                        </p>
                        {% endif %}
                        <p
                            style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--color-text-muted);">
                            Added {{ item.created_date.strftime('%b %d, %Y') }}
                        </p>
                        
                        <!-- Payment Progress -->
                        <div style="margin-top: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.85rem; color: var(--color-text-muted);">Payment Progress</span>
                                <span style="font-size: 0.85rem; font-weight: 600;">GHS {{ "{:,.2f}".format(item.total_paid) }} / {{ "{:,.2f}".format(item.cost) }}</span>
                            </div>
                            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #4caf50; height: 100%; width: {{ (item.total_paid / item.cost * 100) if item.cost > 0 else 0 }}%;"></div>
                            </div>
                        </div>
                        
                        <!-- Payments List -->
                        {% if item.payments %}
                        <div style="margin-top: 0.75rem; padding-left: 0.5rem; border-left: 2px solid #e0e0e0;">
                            <p style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem;">Payments:</p>
                            {% for payment in item.payments %}
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; padding: 0.25rem;">
                                <input type="checkbox"
                                    {% if payment.is_paid %}checked{% endif %}
                                    onchange="togglePayment({{ project.id }}, {{ item.id }}, {{ payment.id }})"
                                    style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="font-size: 0.85rem; flex: 1; {% if payment.is_paid %}text-decoration: line-through; opacity: 0.7;{% endif %}">
                                    {{ payment.description or 'Payment' }} - GHS {{ "{:,.2f}".format(payment.amount) }}
                                </span>
                                <form method="POST"
                                    action="{{ url_for('main.delete_project_item_payment', project_id=project.id, item_id=item.id, payment_id=payment.id) }}"
                                    style="display: inline;"
                                    onsubmit="return confirm('Delete this payment?');">
                                    <button type="submit"
                                        style="background-color: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        üóëÔ∏è
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Add Payment Form -->
                        <details style="margin-top: 0.75rem;">
                            <summary style="cursor: pointer; font-size: 0.85rem; color: var(--color-primary); font-weight: 600;">+ Add Payment</summary>
                            <form method="POST" action="{{ url_for('main.add_project_item_payment', project_id=project.id, item_id=item.id) }}"
                                style="margin-top: 0.5rem; padding: 0.5rem; background: #f9f9f9; border-radius: 4px;">
                                <div style="display: grid; gap: 0.5rem;">
                                    <div>
                                        <input type="number" name="payment_amount" step="0.01" min="0" required
                                            placeholder="Amount (GHS)"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;">
                                    </div>
                                    <div>
                                        <input type="text" name="payment_description"
                                            placeholder="Description (e.g., First payment, Deposit)"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;">
                                    </div>
                                    <button type="submit"
                                        style="background: var(--color-primary); color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                        Add Payment
                                    </button>
                                </div>
                            </form>
                        </details>
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 0.75rem; margin-left: 1rem;">
                        <span
                            style="font-size: 1.25rem; font-weight: 700; color: var(--color-primary);">
                            GHS {{ "{:,.2f}".format(item.cost) }}
                        </span>
                        <a
                            href="{{ url_for('main.edit_project_item', project_id=project.id, item_id=item.id) }}">
                            <button
                                style="background-color: var(--color-primary); padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                                ‚úèÔ∏è
                            </button>
                        </a>
                        <form method="POST"
                            action="{{ url_for('main.delete_project_item', project_id=project.id, item_id=item.id) }}"
                            style="display: inline;"
                            onsubmit="return confirm('Delete this item?');">
                            <button type="submit"
                                style="background-color: var(--color-danger); padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                                üóëÔ∏è
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p
            style="text-align: center; color: var(--color-text-muted); padding: 2rem;">
            No items yet. Add your first item above to get started!
        </p>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteProjectModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
    <div
        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        <h3
            style="margin-top: 0; margin-bottom: 1rem; color: var(--color-danger);">‚ö†Ô∏è
            Delete Project</h3>
        <p style="margin-bottom: 1.5rem; color: var(--color-text-muted);">Are
            you sure you want to delete this project and all its items? This
            action cannot be undone.</p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="hideDeleteProjectDialog()"
                style="background-color: #6b7280; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                Cancel
            </button>
            <button onclick="confirmDeleteProject()"
                style="background-color: #dc2626; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                Delete
            </button>
        </div>
    </div>
</div>

<form id="deleteProjectForm" method="POST"
    action="{{ url_for('main.delete_project', id=project.id) }}"
    style="display: none;">
</form>

<script>
function filterProjectItems() {
    const input = document.getElementById('searchProjectItems');
    const filter = input.value.toLowerCase();
    const cards = document.getElementsByClassName('project-item-card');

    for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const text = card.innerText || card.textContent;
        if (text.toLowerCase().indexOf(filter) > -1) {
            card.style.display = "";
        } else {
            card.style.display = "none";
        }
    }
}

function toggleItem(projectId, itemId) {
    fetch(`/projects/${projectId}/items/${itemId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to update the UI
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update item status');
    });
}

function togglePayment(projectId, itemId, paymentId) {
    fetch(`/projects/${projectId}/items/${itemId}/payments/${paymentId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to update payment progress
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update payment status');
    });
}

// Delete Modal Logic
const deleteModal = document.getElementById('deleteProjectModal');
const deleteForm = document.getElementById('deleteProjectForm');

function showDeleteProjectDialog() {
    deleteModal.style.display = 'block';
}

function hideDeleteProjectDialog() {
    deleteModal.style.display = 'none';
}

function confirmDeleteProject() {
    deleteForm.submit();
}

// Close modal when clicking outside
deleteModal.addEventListener('click', function(e) {
    if (e.target === this) {
        hideDeleteProjectDialog();
    }
});
</script>
{% endblock %}
